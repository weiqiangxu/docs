# 限频

### 1.令牌桶算法（Token Bucket Algorithm）

一种用于流量控制和速率限制的算法。令牌桶有一个固定的容量，并且以一个恒定的速率向桶中放入令牌。令牌按照固定的速率（通常以每秒产生多少个令牌来衡量）被添加到令牌桶中，这个速率决定了允许通过的请求的平均速率。


### 2.漏桶算法（Leaky Bucket Algorithm）

固定容量的桶，请求像水一样流入桶中，水以固定的速率从桶底的小孔流出。


> 令牌桶和漏桶的区别在于，令牌桶算法允许一定程度的突发流量，因为桶中可以预先积累令牌。漏桶算法的输出速率是固定的，不能处理突发流量，它主要用于平滑流量，使得请求以一个稳定的速率被处理。



### 3.实现方式


1. 滑动窗口限流

    滑动窗口限流是一种在一定时间范围内控制请求频率的方法。将时间划分为多个时间窗口（可以是秒、毫秒等），通过记录每个时间窗口内的请求次数来判断是否超过频率限制。滑动窗口可以更加平滑地处理请求，避免在时间窗口边界出现突发流量问题。
    使用 Redis 的有序集合（ZSET）来实现滑动窗口，有序集合的每个元素的分数（score）可以用来记录请求的时间戳，元素的值可以是一个唯一的请求标识（如请求 ID 或者客户端 IP 等），通过有序集合可以方便地根据时间戳对请求进行排序和范围查询。
    
    > Redis 的有序集合（Zset）中，元素是唯一的。一个给定的有序集合键（key），不能有两个完全相同的元素存在。所以执行 `ZADD myzset 1 element1` 再次执行 `ZADD myzset 2 element1` ，实际上并不会添加一个新的element1，而是会更新element1这个元素对应的分数。

    ```bash
    # 1.用户请求进来的时候
    # score是毫秒
    # 可以有多个相同score的元素
    # ZADD key score member
    $ ZADD  $user_id  $timestamp  $request_uuid


    # 2.统计1分钟以内的请求总数
    # 统计最近1min总次数
    # ZCOUNT key min max
    $ ZCOUNT  $user_id  $start_time $end_time


    # 3.移除2min以前的请求计数
    $ ZREMRANGEBYSCORE $user_id 0 $two_min_ago_timestamp
    ```